{% extends 'core/page.html' %}
{% load staticfiles %}
{% load compress %}
{% load i18n %}
{% load core_tags %}


{% block head %}
{% compress css %}
<link rel="stylesheet" type="text/x-scss" href="{% static 'projects/css/project_questions_form.scss' %}" />
{% endcompress %}

<script type="text/javascript" src="{% static 'angular/angular.min.js' %}" ></script>
<script type="text/javascript" src="{% static 'projects/js/project_questions_form.js' %}" ></script>
{% endblock %}


{% block page %}

    <h2>{% trans 'Questionaire' %}</h2>

    <h4>
        {{ title }}
    </h4>

    <div class="project-questions-form"
         ng-app="project_questions_form" ng-controller="FormController"
         ng-init='service.init({{ options_json|safe }})'>

        <form ng-submit="service.saveAndNext()">

        {% if questionset %}

            {% if questionset.attributeset.is_collection %}

            <div class="questionset-head">
                <div class="pull-right">
                    <button type="button" class="btn btn-success" ng-click="service.addValueSet()">
                        {% trans 'Add new set' %}
                    </button>
                    <button type="button" class="btn btn-danger" ng-click="service.removeValueSet()">
                        {% trans 'Remove set' %}
                    </button>
                </div>

                <ul class="pagination">
                    <li ng-class="{ active: valueset == service.valueset }"
                        ng-repeat="valueset in service.values['{{ questionset.attributeset }}']">
                        <a href="" ng-click="service.valueset = valueset">#{$ $index + 1 $}</a>
                    </li>
                </ul>
            </div>

            {% endif %}

            {% for question in questionset.questions.all %}
            {% with question.attribute.tag as tag %}

            <div>
                <div class="form-group field-{{ tag }}">
                    <label for="id_{{ tag }}">{{ question.text }}</label>

                    {% if question.attribute.is_collection %}

                    <div class="input-group input-collection" ng-repeat="value in service.valueset['{{ tag }}'] track by $index">

                        <input class="form-control" type="text" ng-model="service.valueset['{{ tag }}'][$index]"/>

                        <div class="input-group-btn">
                            <button type="button" class="btn btn-danger" tabindex="-1"
                                    ng-click="service.removeValueSetValue('{{ tag }}', $index)">
                                {% trans 'Remove' %}
                            </button>
                        </div>
                    </div>

                    <div class="form-group">
                        <button type="button" class="btn btn-success" ng-click="service.addValueSetValue('{{ tag }}')">
                            {% trans 'Add new item' %}
                        </button>
                    </div>

                    {% else %}

                    <input class="form-control" type="text" ng-model="service.valueset['{{ tag }}']"/>

                    {% endif %}

                </div>
            </div>

            {% endwith %}
            {% endfor %}

        {% else %}
        {% with question.attribute.tag as tag %}

            <div class="form-group field-{{ tag }}">
                <label for="id_{{ tag }}">{{ question.text }}</label>

                {% if question.attribute.is_collection %}

                <div class="input-group input-collection" ng-repeat="value in service.values['{{ tag }}'] track by $index">

                    <input class="form-control" type="text" ng-model="service.values['{{ tag }}'][$index]"/>

                    <div class="input-group-btn">
                        <button type="button" class="btn btn-danger" tabindex="-1"
                                ng-click="service.removeValue('{{ tag }}', $index)">
                            {% trans 'Remove' %}
                        </button>
                    </div>
                </div>

                {% else %}

                <input class="form-control" type="text" ng-model="service.values['{{ tag }}']"/>

                {% endif %}

            </div>

            {% if question.attribute.is_collection %}

            <div class="form-group">
                <button type="button" class="btn btn-success" ng-click="service.addValue('{{ tag }}')">
                    {% trans 'Add new item' %}
                </button>
            </div>

            {% endif %}

        {% endwith %}
        {% endif %}

            <div class="help-block error" ng-show="service.errors"></div>

            <div class="form-group pull-right">
                <button type="button" class="btn btn-default" ng-disabled="!service.options.prev" ng-click="service.prev()">
                    {% trans 'Previous' %}
                </button>
                <button type="button" class="btn btn-default" ng-disabled="!service.options.next" ng-click="service.next()">
                    {% trans 'Next' %}
                </button>
            </div>

            <div class="form-group">
                <button type="button" class="btn btn-default" ng-click="service.save()">
                    {% trans 'Save' %}
                </button>
                <button type="button" class="btn btn-primary" ng-click="service.saveAndNext()">
                    {% trans 'Save and continue' %}
                </button>
            </div>

            <pre>{$ service.values $}</pre>
            <pre>{$ service.valueset $}</pre>

        </form>
    </div>

{% endblock %}

{% block sidebar %}

    <h3>{% trans 'Progress' %}</h3>

    <div class="progress">
        <div class="progress-bar" role="progressbar" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100" style="width: {{ progress }}%;">
            <span class="sr-only">{{ progress }}% Complete</span>
        </div>
    </div>

    <h3>{% trans 'Options' %}</h3>

    <ul class="list-unstyled">
        <li>{% internal_link _('Back to project') 'project' project.id %}</li>
    </ul>

{% endblock %}
